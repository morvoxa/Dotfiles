#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

ROOT_DIR="$(pwd)"
CONFIG_DIR="$ROOT_DIR/config"
HOME_CONFIG="$HOME/.config"

log() {
    printf "[INFO] %s\n" "$1"
}

ensure_dir() {
    mkdir -p "$1"
}

sync_dir() {
    local src="$1"
    local dest="$2"

    if [[ -d "$src" ]]; then
        ensure_dir "$dest"
        rsync -avh --delete "$src/" "$dest/" >/dev/null
        log "Ready ... $(basename "$dest")"
    else
        log "Skipped ... $(basename "$src") (not found)"
    fi
}

# ==========================================================
# Neovim dev check
# ==========================================================
if [[ -f "$HOME/.bin/nvim" ]]; then
    log "neovim dev ready"
else
    log "installing neovim dev"
    "$ROOT_DIR/bin/script/install_nvim_dev"
fi

# ==========================================================
# Ensure ~/.config
# ==========================================================
ensure_dir "$HOME_CONFIG"
log "Config directory ready"

# ==========================================================
# Sync common configs
# ==========================================================
for d in starship nvim alacritty; do
    sync_dir "$CONFIG_DIR/$d" "$HOME_CONFIG/$d"
done

# Niri (tanpa --delete)
sync_dir "$CONFIG_DIR/niri" "$HOME_CONFIG/niri"
sync_dir "$CONFIG_DIR/kitty" "$HOME_CONFIG/kitty"

# ==========================================================
# Code - OSS
# ==========================================================
CODE_OSS_DIR="Code - OSS"
sync_dir "$HOME/Dotfiles/config/$CODE_OSS_DIR" "$HOME_CONFIG/$CODE_OSS_DIR"

# ==========================================================
# Home dotfiles
# ==========================================================
for f in "$CONFIG_DIR/home/"*; do
    [[ -f "$f" ]] || continue
    rsync -avh "$f" "$HOME/.${f##*/}" >/dev/null
    log "Ready ... .${f##*/}"
done

# ==========================================================
# systemd dms service
# ==========================================================
DMS_SERVICE="$HOME/.config/systemd/user/graphical-session.target.wants/dms.service"
if [[ -f "$DMS_SERVICE" ]]; then
    log "dms service ready"
else
    log "dms service disabled"
    # systemctl --user enable dms
fi

# ==========================================================
# Rofi menu
# ==========================================================
ROFI_APP_DIR="$HOME/.local/share/applications"
ensure_dir "$ROFI_APP_DIR"

cp "$CONFIG_DIR/rofi-menu/chatgpt.desktop" "$ROFI_APP_DIR/"
log "rofi menu updated"

log "All setup completed âœ”"
