#!/usr/bin/env bash
set -e

echo "==> Updating system & installing dependencies..."
sudo apt update
sudo apt install -y curl xz-utils ca-certificates

echo "==> Installing Nix (single-user, no daemon)..."
sh <(curl -L https://nixos.org/nix/install) --no-daemon

echo "==> Loading Nix environment..."
if [ -f "$HOME/.nix-profile/etc/profile.d/nix.sh" ]; then
  . "$HOME/.nix-profile/etc/profile.d/nix.sh"
else
  echo "ERROR: nix.sh not found"
  exit 1
fi

echo "==> Enabling nix-command & flakes..."
mkdir -p "$HOME/.config/nix"
cat <<EOF > "$HOME/.config/nix/nix.conf"
experimental-features = nix-command flakes
EOF

echo "==> Adding Nix to bash startup..."
if ! grep -q "nix.sh" "$HOME/.bashrc"; then
  echo '. ~/.nix-profile/etc/profile.d/nix.sh' >> "$HOME/.bashrc"
fi

echo "==> Verifying Nix installation..."
nix --version

echo "==> Installing Home Manager..."
nix run home-manager/master -- init --switch

echo
echo "✅ Nix + Flakes + Home Manager installed successfully"
echo "➡ Restart your shell or run: exec \$SHELL"

