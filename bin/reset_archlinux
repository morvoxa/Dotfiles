#!/bin/sh
set -e

# ===============================
# Konfigurasi
# ===============================
EXPLICIT_PKGS="
base
linux
linux-firmware
grub
efibootmgr
os-prober
networkmanager
zsh
rsync
vim
git
sudo
bash
glibc
gcc-libs
"

FLAG="/var/lib/pacman/.orphan-cleanup-done"
ULTRA_FLAG="/var/lib/pacman/.ultra-cleanup-done"

# ===============================
# Safety check
# ===============================
if [ "$EUID" -ne 0 ]; then
  echo "Harus dijalankan sebagai root."
  exit 1
fi

echo "==> Arch ultra-aggressive cleanup (user-safe)"

# ===============================
# Step 1: Reset explicit lama
# ===============================
echo "==> Reset paket explicit lama menjadi dependency"
pacman -Qq --explicit | pacman -D --asdeps -

# ===============================
# Step 2: Tandai paket inti
# ===============================
echo "==> Menandai paket inti sebagai explicit"
for pkg in $EXPLICIT_PKGS; do
  if pacman -Qi "$pkg" >/dev/null 2>&1; then
    pacman -D --asexplicit "$pkg"
  else
    echo "  - (skip) $pkg tidak terpasang"
  fi
done

# ===============================
# Step 3: Tampilkan orphan
# ===============================
echo "==> Orphan packages:"
ORPHANS="$(pacman -Qtdq || true)"
if [ -z "$ORPHANS" ]; then
  echo "  (tidak ada orphan)"
else
  echo "$ORPHANS"
fi

# ===============================
# Step 4: Hapus orphan
# ===============================
if [ ! -f "$FLAG" ] && [ -n "$ORPHANS" ]; then
  read -p "Lanjut hapus orphan? (yes/no): " ans
  if [ "$ans" = "yes" ]; then
    echo "==> Menghapus orphan packages"
    echo "$ORPHANS" | pacman -Rns -
    touch "$FLAG"
  else
    echo "Dibatalkan."
  fi
fi

# ===============================
# Step 5: Hapus cache paket pacman
# ===============================
echo "==> Menghapus semua cache paket pacman (/var/cache/pacman/pkg)"
pacman -Scc --noconfirm

# ===============================
# Step 6: Hapus konfigurasi user non-default
# ===============================
echo "==> Menghapus konfigurasi user (~/.config, ~/.zshrc, ~/.vimrc, ~/.cache)"
USERS=$(awk -F: '$3 >= 1000 && $1 != "nobody" {print $1}' /etc/passwd)

for user in $USERS; do
  HOME_DIR=$(eval echo "~$user")
  echo "  - Membersihkan konfigurasi user: $user"

  rm -f "$HOME_DIR/.zshrc" "$HOME_DIR/.vimrc"
  rm -rf "$HOME_DIR/.config" "$HOME_DIR/.cache"
done

# ===============================
# Step 7: Hapus temp & log lama
# ===============================
echo "==> Membersihkan /tmp dan log lama"
rm -rf /tmp/*
journalctl --rotate
journalctl --vacuum-time=1s

touch "$ULTRA_FLAG"

echo "==> ULTRA CLEANUP SELESAI! Sistem sudah dibersihkan secara agresif."

