#!/bin/sh
set -eu

# ===============================
# Konfigurasi
# ===============================
EXPLICIT_PKGS="
base
linux
linux-firmware
grub
efibootmgr
os-prober
networkmanager
openssh
sudo
zsh
vim
git
bash
glibc
gcc-libs
"

echo "==> Arch repeatable ultra-cleanup"

# ===============================
# Safety check
# ===============================
if [ "$(id -u)" -ne 0 ]; then
  echo "Harus dijalankan sebagai root."
  exit 1
fi

# ===============================
# Step 1: Reset explicit lama (IDEMPOTENT)
# ===============================
echo "==> Reset explicit package (selain core) menjadi dependency"

pacman -Qq --explicit | while read -r pkg; do
  echo "$EXPLICIT_PKGS" | grep -qx "$pkg" || pacman -D --asdeps "$pkg" 2>/dev/null || true
done

# ===============================
# Step 2: Tandai core packages sebagai explicit
# ===============================
echo "==> Menandai core packages sebagai explicit"

for pkg in $EXPLICIT_PKGS; do
  pacman -Qi "$pkg" >/dev/null 2>&1 && pacman -D --asexplicit "$pkg" || true
done

# ===============================
# Step 3: Cari orphan (SAFE)
# ===============================
echo "==> Mencari orphan packages"
ORPHANS="$(pacman -Qtdq || true)"

if [ -z "$ORPHANS" ]; then
  echo "  (tidak ada orphan)"
else
  echo "==> Orphan packages ditemukan:"
  echo "$ORPHANS" | sed 's/^/  - /'

  echo
  echo "==> Paket di atas AKAN DIHAPUS"
  printf "Lanjutkan? [y/N] "
  read -r confirm

  case "$confirm" in
    y|Y)
      echo "==> Menghapus orphan packages"
      echo "$ORPHANS" | pacman -Rns -
      ;;
    *)
      echo "==> Dibatalkan oleh user"
      exit 0
      ;;
  esac
fi

# ===============================
# Step 4: Bersihkan pacman cache (REPEATABLE)
# ===============================
echo "==> Membersihkan pacman cache"
yes | pacman -Scc >/dev/null

# ===============================
# Step 5: Bersihkan cache user SAJA (AMAN)
# ===============================
echo "==> Membersihkan cache user (~/.cache saja)"

awk -F: '$3 >= 1000 && $1 != "nobody" {print $1}' /etc/passwd | while read -r user; do
  HOME_DIR=$(eval echo "~$user")
  [ -d "$HOME_DIR/.cache" ] && rm -rf "$HOME_DIR/.cache"/*
done
rm /home/mor/.zshrc

# ===============================
# Step 6: Bersihkan tmp & journal (AMAN)
# ===============================
echo "==> Membersihkan /tmp & journal"
systemd-tmpfiles --clean
journalctl --rotate
journalctl --vacuum-time=1s

echo "==> CLEANUP SELESAI (repeatable, no prompt)"

